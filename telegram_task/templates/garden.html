<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± G$ Garden - GoodDollar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            color: #f1f5f9;
            padding: 2rem;
            zoom: 0.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stats-bar {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(16, 185, 129, 0.1);
            padding: 1rem 2rem;
            border-radius: 12px;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .garden-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .garden-plot {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.1));
            border: 3px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            position: relative;
            min-height: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .garden-plot:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .plot-crop {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s ease;
        }

        .ai-farmer {
            position: absolute;
            font-size: 2rem;
            animation: walking 3s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes walking {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(20px); }
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-plant {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-harvest {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }

        .ai-helpers-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 16px;
            margin-top: 2rem;
        }

        .helper-card {
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid rgba(99, 102, 241, 0.3);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            display: none;
            z-index: 1000;
        }

        /* Transaction History Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .close-modal {
            float: right;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
        }

        .transaction-table th {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .transaction-table tr:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .tx-link {
            color: #6366f1;
            text-decoration: none;
            font-family: monospace;
            font-weight: 600;
        }

        .tx-link:hover {
            text-decoration: underline;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/minigames" class="btn" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; margin-bottom: 1rem; display: inline-block;">‚Üê Back to Minigames</a>
        <button class="btn" onclick="openTransactionHistory()" style="background: rgba(99, 102, 241, 0.2); color: #6366f1; margin-bottom: 1rem; display: inline-block; margin-left: 1rem;">
            Transaction History
        </button>

        <div class="header">
            <h1>üå± G$ Garden</h1>
            <p>Plant, grow, and harvest virtual crops to earn G$ points!</p>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <div style="font-size: 0.9rem; opacity: 0.8;">Harvests Today</div>
                <div style="font-size: 1.5rem; font-weight: 700;" id="harvests-count">0 / 10</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 0.9rem; opacity: 0.8;">Total Earned</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #fbbf24;" id="total-earned">Loading...</div>
                <button class="btn" onclick="syncBalance()" id="sync-btn" style="margin-top: 0.5rem; font-size: 0.8rem; padding: 0.4rem 0.8rem; background: rgba(99, 102, 241, 0.2); color: #6366f1; display: none;">
                    üîÑ Sync Balance
                </button>
            </div>
            <div class="stat-card">
                <div style="font-size: 0.9rem; opacity: 0.8;">Available Balance</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;" id="available-balance">Loading...</div>
                <button class="btn btn-harvest" onclick="withdrawBalance()" id="withdraw-btn" style="margin-top: 0.5rem; font-size: 0.9rem; padding: 0.5rem 1rem;" disabled>
                    üí∞ Withdraw (Min: 200 G$)
                </button>
            </div>
        </div>

        <div class="garden-grid" id="garden-grid">
            <!-- AI Farmer will appear here -->
            <div class="ai-farmer" id="ai-farmer" style="display: none;">üßë‚Äçüåæ</div>

            <!-- Plots will be generated by JavaScript -->
        </div>

        <div class="ai-helpers-section">
            <h2>ü§ñ AI Helpers</h2>
            <p style="margin-bottom: 1rem; opacity: 0.8;">Hire AI farmers to auto-water and auto-harvest your crops!</p>

            <div class="helper-card">
                <h3>üßë‚Äçüåæ Basic Farmer - 500 G$</h3>
                <p>Auto-waters 2 plots</p>
                <button class="btn btn-plant" onclick="hireHelper('basic')">Hire Basic Farmer</button>
            </div>

            <div class="helper-card">
                <h3>üë®‚Äçüåæ Expert Farmer - 1,500 G$</h3>
                <p>Auto-waters 4 plots + 10% growth boost</p>
                <button class="btn btn-plant" onclick="hireHelper('expert')">Hire Expert Farmer</button>
            </div>

            <div class="helper-card">
                <h3>üë©‚Äçüåæ Master Farmer - 5,000 G$</h3>
                <p>Auto-waters all plots + 25% growth boost + Auto-harvest!</p>
                <button class="btn btn-plant" onclick="hireHelper('master')">Hire Master Farmer</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Transaction History Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content" id="transactionContent">
            <!-- Transaction history will be loaded here -->
        </div>
    </div>

    <script>
        let gardenState = null;

        async function loadGardenState() {
            try {
                const response = await fetch('/minigames/garden/state');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.success) {
                    gardenState = data;
                    renderGarden();
                    updateStats();
                } else {
                    console.error('‚ùå Garden state loading failed:', data.error);
                }
            } catch (error) {
                console.error('‚ùå Error loading garden:', error);
            }
        }

        // Add auto-refresh every 1 second for real-time countdown
        setInterval(loadGardenState, 1000);

        function renderGarden() {
            const grid = document.getElementById('garden-grid');
            const aiFarmer = document.getElementById('ai-farmer');

            if (!grid) {
                console.error('‚ùå Garden grid not found!');
                return;
            }

            // Clear existing plots
            grid.innerHTML = '';

            // Show AI farmer if user has helpers
            if (gardenState.ai_helpers && gardenState.ai_helpers.length > 0) {
                if (aiFarmer) aiFarmer.style.display = 'block';
            }

            // Create 6 plots
            for (let i = 0; i < 6; i++) {
                const plot = gardenState.plots.find(p => p.plot_id === i);
                const plotDiv = document.createElement('div');
                plotDiv.className = 'garden-plot';
                plotDiv.dataset.plotId = i;

                if (plot && plot.status === 'growing') {
                    // Normalize crop type for CSS classes and emoji
                    const cropType = plot.crop_type ? plot.crop_type.toLowerCase() : 'tomato';
                    const growth = plot.growth_percent || 0;
                    
                    // Calculate remaining time
                    const startTime = new Date(plot.planted_at).getTime();
                    const now = new Date().getTime();
                    const cropConfig = gardenState.available_crops[plot.crop_type];
                    const totalTimeMs = (cropConfig ? cropConfig.growth_time_minutes : 10) * 60 * 1000;
                    const elapsedMs = now - startTime;
                    const remainingMs = Math.max(0, totalTimeMs - elapsedMs);
                    
                    let timeString = '';
                    if (growth < 100 && remainingMs > 0) {
                        const mins = Math.floor(remainingMs / 60000);
                        const secs = Math.floor((remainingMs % 60000) / 1000);
                        timeString = `<div class="timer" style="font-family: monospace; color: #fbbf24; font-weight: bold; margin-top: 0.5rem;">
                            ‚è≥ ${mins}:${secs.toString().padStart(2, '0')}
                        </div>`;
                    }

                    let emoji = 'üå±';
                    if (growth >= 100) {
                        if (cropType === 'tomato') emoji = 'üçÖ';
                        else if (cropType === 'corn') emoji = 'üåΩ';
                        else if (cropType === 'carrot') emoji = 'ü•ï';
                    } else if (growth > 50) {
                        emoji = 'üåø';
                    }

                    plotDiv.innerHTML = `
                        <div class="plot-crop">${emoji}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${growth}%"></div>
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                            <strong>${cropType.charAt(0).toUpperCase() + cropType.slice(1)}</strong><br>
                            ${Math.floor(growth)}% grown
                            ${timeString}
                        </div>
                        ${growth >= 100 ? '<button class="btn btn-harvest" onclick="harvestPlot(' + i + ')" style="margin-top: 1rem; width: 100%;">üåæ Harvest</button>' : ''}
                    `;
                    
                    if (growth >= 100) {
                        plotDiv.classList.add('ready');
                    }
                } else {
                    plotDiv.innerHTML = `
                        <div class="plot-crop" style="opacity: 0.5;">üå±</div>
                        <div style="margin-bottom: 1rem;">Empty Plot</div>
                        <button class="btn btn-plant" onclick="showPlantMenu(${i})" style="width: 100%;">Plant Crop</button>
                    `;
                }

                grid.appendChild(plotDiv);
            }

            // Re-add AI farmer if it exists
            if (aiFarmer) {
                grid.appendChild(aiFarmer);
            }
        }

        function updateStats() {
            const harvestsToday = gardenState.harvests_today || 0;
            const harvestsRemaining = Math.max(0, 10 - harvestsToday);
            
            const harvestsCountEl = document.getElementById('harvests-count');
            if (harvestsCountEl) {
                harvestsCountEl.textContent = `${harvestsToday} / 10`;
            }

            // Update balance information with explicit number conversion
            if (gardenState.balance) {
                // IMPORTANT: Use available_balance directly from the API response
                const totalEarned = parseFloat(gardenState.balance.total_earned) || 0;
                const availableBalance = parseFloat(gardenState.balance.available_balance) || 0;

                const totalEarnedEl = document.getElementById('total-earned');
                const availableBalanceEl = document.getElementById('available-balance');
                
                console.log('üí∞ UI Update - Available Balance:', availableBalance);
                
                if (totalEarnedEl) totalEarnedEl.textContent = `${totalEarned.toFixed(2)} G$`;
                if (availableBalanceEl) availableBalanceEl.textContent = `${availableBalance.toFixed(2)} G$`;

                // Show sync button if user has harvests but balance is 0
                const syncBtn = document.getElementById('sync-btn');
                if (syncBtn) {
                    if (harvestsToday > 0 && totalEarned === 0) {
                        syncBtn.style.display = 'inline-block';
                    } else {
                        syncBtn.style.display = 'none';
                    }
                }

                // Enable/disable withdraw button
                const withdrawBtn = document.getElementById('withdraw-btn');
                if (withdrawBtn) {
                    if (availableBalance >= 200) {
                        withdrawBtn.disabled = false;
                        withdrawBtn.style.opacity = '1';
                        withdrawBtn.style.cursor = 'pointer';
                    } else {
                        withdrawBtn.disabled = true;
                        withdrawBtn.style.opacity = '0.5';
                        withdrawBtn.style.cursor = 'not-allowed';
                    }
                }
            }
        }

        async function syncBalance() {
            try {
                showNotification('Syncing balance from harvest history...', 'info');

                const response = await fetch('/minigames/garden/sync-balance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadGardenState(); // Reload to update balance
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error syncing balance:', error);
                showNotification('Error syncing balance', 'error');
            }
        }

        async function withdrawBalance() {
            if (!confirm('Withdraw your available garden balance to your wallet?')) {
                return;
            }

            try {
                const withdrawBtn = document.getElementById('withdraw-btn');
                withdrawBtn.disabled = true;
                withdrawBtn.textContent = '‚è≥ Processing...';

                const response = await fetch('/minigames/garden/withdraw', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                
                // Re-enable button
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = 'üí∞ Withdraw (Min: 200 G$)';

                if (data.success) {
                    showNotification(`${data.message}\nTx: ${data.tx_hash.substring(0, 10)}...`, 'success');
                    loadGardenState(); // Reload to update balance
                } else {
                    // Check if it's a system error (GAMES_KEY issue)
                    if (data.system_error || data.error.includes('system') || data.error.includes('unavailable')) {
                        showNotification('‚ö†Ô∏è ' + data.error + '\n\nPlease contact t.me/GoodDollarX about this issue.', 'error', 8000);
                    } else {
                        showNotification(data.error, 'error');
                    }
                }
            } catch (error) {
                console.error('Withdrawal error:', error);
                showNotification('Error withdrawing balance. Please contact t.me/GoodDollarX', 'error');
                
                // Re-enable button
                const withdrawBtn = document.getElementById('withdraw-btn');
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = 'üí∞ Withdraw (Min: 200 G$)';
            }
        }

        function handlePlotClick(plotId) {
            // Handled by button clicks
        }

        function showPlantMenu(plotId) {
            const crop = prompt('Choose crop:\n1. üçÖ Tomato (10min, 5 G$)\n2. üåΩ Corn (1hr, 8 G$)\n3. ü•ï Carrot (24hr, 10 G$)\n\nEnter 1, 2, or 3:');

            const cropMap = {'1': 'tomato', '2': 'corn', '3': 'carrot'};
            if (cropMap[crop]) {
                plantCrop(plotId, cropMap[crop]);
            }
        }

        async function plantCrop(plotId, cropType) {
            try {
                const response = await fetch('/minigames/garden/plant', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({plot_id: plotId, crop_type: cropType})
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadGardenState();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error planting crop', 'error');
            }
        }

        async function harvestPlot(plotId) {
            try {
                const response = await fetch('/minigames/garden/harvest', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({plot_id: plotId})
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadGardenState();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error harvesting crop', 'error');
            }
        }

        async function hireHelper(helperType) {
            try {
                const response = await fetch('/minigames/garden/hire-helper', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({helper_type: helperType})
                });

                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadGardenState();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error hiring helper', 'error');
            }
        }

        function showNotification(message, type, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? 'rgba(16, 185, 129, 0.95)' : 
                                           type === 'info' ? 'rgba(99, 102, 241, 0.95)' :
                                           'rgba(239, 68, 68, 0.95)';
            notification.style.display = 'block';
            notification.style.whiteSpace = 'pre-line';
            notification.style.padding = '1.5rem';
            notification.style.maxWidth = '500px';

            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        async function openTransactionHistory() {
            try {
                const modal = document.getElementById('transactionModal');
                const content = document.getElementById('transactionContent');

                modal.style.display = 'flex';
                content.innerHTML = `
                    <button class="close-modal" onclick="closeTransactionModal()">‚úï Close</button>
                    <h2 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.8rem;">
                        <i class="fas fa-history"></i> Withdrawal History
                    </h2>
                    <p style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">Loading...</p>
                `;

                const response = await fetch('/minigames/garden/withdrawal-history');
                const data = await response.json();

                console.log('üìä Withdrawal history response:', data);

                if (!data.success) {
                    content.innerHTML = `
                        <button class="close-modal" onclick="closeTransactionModal()">‚úï Close</button>
                        <h2 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.8rem;">
                            <i class="fas fa-history"></i> Withdrawal History
                        </h2>
                        <p style="text-align: center; color: #ef4444; padding: 2rem;">Failed to load transaction history. Please try again.</p>
                    `;
                    return;
                }

                // Show warning if there was an issue but still showing data
                if (data.warning) {
                    console.warn('‚ö†Ô∏è Warning:', data.warning);
                }

                const withdrawals = data.withdrawals || [];

                if (withdrawals.length === 0) {
                    content.innerHTML = `
                        <button class="close-modal" onclick="closeTransactionModal()">‚úï Close</button>
                        <h2 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.8rem;">
                            <i class="fas fa-history"></i> Withdrawal History
                        </h2>
                        <div style="text-align: center; padding: 3rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üå±</div>
                            <p style="color: rgba(255,255,255,0.7); font-size: 1.2rem; margin-bottom: 0.5rem;">
                                No withdrawals yet
                            </p>
                            <p style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">
                                Start harvesting crops to earn G$ and make your first withdrawal!
                            </p>
                        </div>
                    `;
                    return;
                }

                const totalWithdrawn = withdrawals.reduce((sum, w) => sum + parseFloat(w.amount || 0), 0);

                let html = `
                    <button class="close-modal" onclick="closeTransactionModal()">‚úï Close</button>
                    <h2 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.8rem;">
                        <i class="fas fa-history"></i> Withdrawal History
                    </h2>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; border: 2px solid rgba(16, 185, 129, 0.3);">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem;">Total Withdrawals</div>
                        <div style="font-size: 2.5rem; font-weight: 900; color: #10b981;">
                            ${totalWithdrawn.toFixed(2)} G$
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 0.5rem;">
                            ${withdrawals.length} transaction${withdrawals.length !== 1 ? 's' : ''}
                        </div>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th style="text-align: right;">Amount</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: center;">Transaction</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                withdrawals.forEach(w => {
                    const date = new Date(w.created_at);
                    const status = w.status || 'completed';
                    const statusClass = status === 'completed' ? 'status-completed' : 
                                       status === 'failed' ? 'status-failed' : 'status-pending';

                    html += `
                        <tr>
                            <td>${date.toLocaleString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</td>
                            <td style="text-align: right; font-weight: 700; color: #10b981; font-size: 1.1rem;">
                                ${parseFloat(w.amount).toFixed(2)} G$
                            </td>
                            <td style="text-align: center;">
                                <span class="status-badge ${statusClass}">
                                    ${status.toUpperCase()}
                                </span>
                            </td>
                            <td style="text-align: center;">
                                ${w.tx_hash ? `
                                    <a href="https://explorer.celo.org/mainnet/tx/${w.tx_hash}" 
                                       target="_blank"
                                       class="tx-link"
                                       title="View on Celo Explorer">
                                        ${w.tx_hash.substring(0, 6)}...${w.tx_hash.substring(w.tx_hash.length - 4)}
                                        <i class="fas fa-external-link-alt" style="font-size: 0.7rem; margin-left: 0.25rem;"></i>
                                    </a>
                                ` : '<span style="color: rgba(255,255,255,0.3);">Pending</span>'}
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                content.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Error loading transaction history:', error);
                const content = document.getElementById('transactionContent');
                content.innerHTML = `
                    <button class="close-modal" onclick="closeTransactionModal()">‚úï Close</button>
                    <h2 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.8rem;">
                        <i class="fas fa-history"></i> Withdrawal History
                    </h2>
                    <p style="text-align: center; color: #ef4444; padding: 2rem;">
                        Error loading transaction history. Please try again.
                    </p>
                `;
                showNotification('Failed to load transaction history', 'error');
            }
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transactionModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('transactionModal');
            if (event.target === modal) {
                closeTransactionModal();
            }
        }

        // Auto-refresh garden state every 5 seconds
        setInterval(loadGardenState, 5000);

        // Initial load
        loadGardenState();
    </script>
</body>
</html>
